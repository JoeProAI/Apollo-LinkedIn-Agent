<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apollo LinkedIn Agent - International Graduate Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="apolloAgent()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Apollo LinkedIn Agent</h1>
            <p class="text-xl text-gray-600">International Graduate Discovery Platform</p>
            <div class="mt-4">
                <button @click="testConnection()" 
                        :disabled="testing"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg disabled:opacity-50">
                    <span x-show="!testing">Test API Connection</span>
                    <span x-show="testing">Testing...</span>
                </button>
                <div x-show="connectionStatus" class="mt-2">
                    <span :class="connectionSuccess ? 'text-green-600' : 'text-red-600'" 
                          x-text="connectionMessage"></span>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Search Parameters</h2>
            
            <form @submit.prevent="searchCandidates()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Keywords</label>
                        <input type="text" 
                               x-model="searchParams.keywords"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="graduate OR international OR visa">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <select x-model="searchParams.location" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="United States">United States</option>
                            <option value="California, United States">California</option>
                            <option value="New York, United States">New York</option>
                            <option value="Texas, United States">Texas</option>
                            <option value="Washington, United States">Washington</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Job Titles</label>
                        <input type="text" 
                               x-model="searchParams.titles"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="software engineer, developer, analyst">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Type</label>
                        <select x-model="searchParams.searchVariation" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="default">Default Search</option>
                            <option value="visa_focus">Visa/Sponsorship Focus</option>
                            <option value="new_grad">New Graduate Focus</option>
                            <option value="university">University Graduate</option>
                            <option value="tech_specific">Tech Specific</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Results Per Page</label>
                        <select x-model="searchParams.limit" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10 candidates</option>
                            <option value="25">25 candidates</option>
                            <option value="50">50 candidates</option>
                        </select>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" 
                            :disabled="searching"
                            class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg disabled:opacity-50 text-lg">
                        <span x-show="!searching">üîç Search Candidates</span>
                        <span x-show="searching">Searching...</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Results -->
        <div x-show="results.length > 0" class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Search Results</h2>
                <div class="flex items-center space-x-3">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium"
                          x-text="`${results.length} candidates found`"></span>
                    <button @click="tryDifferentSearch()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                        Try Different Search
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="candidate in results" :key="candidate.linkedin_url">
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <h3 class="font-semibold text-lg text-gray-900" x-text="candidate.full_name"></h3>
                        <p class="text-blue-600 font-medium mb-2" x-text="candidate.title"></p>
                        <p class="text-gray-600 text-sm mb-1">
                            <span class="font-medium">Company:</span> 
                            <span x-text="candidate.company"></span>
                        </p>
                        <p class="text-gray-600 text-sm mb-3">
                            <span class="font-medium">Location:</span> 
                            <span x-text="candidate.location"></span>
                        </p>
                        <div class="flex space-x-2">
                            <a :href="candidate.linkedin_url" 
                               target="_blank"
                               class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                LinkedIn
                            </a>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs"
                                  x-text="candidate.seniority"></span>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Load More Button -->
            <div class="text-center mt-6">
                <button @click="loadMoreCandidates()" 
                        :disabled="searching"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg disabled:opacity-50">
                    <span x-show="!searching">Load More Candidates</span>
                    <span x-show="searching">Loading...</span>
                </button>
            </div>
        </div>

        <!-- Error Display -->
        <div x-show="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <span x-text="error"></span>
        </div>
    </div>

    <script>
        function apolloAgent() {
            return {
                searchParams: {
                    keywords: 'graduate OR student OR international OR visa OR OPT OR F1 OR H1B OR recent graduate OR new graduate',
                    location: 'United States',
                    seniority: 'entry,junior',
                    titles: 'software engineer, developer, analyst, associate, intern, graduate, new grad',
                    limit: 25,
                    page: 1,
                    searchVariation: 'default'
                },
                currentPage: 1,
                seenCandidates: new Set(),
                results: [],
                searching: false,
                testing: false,
                connectionStatus: false,
                connectionSuccess: false,
                connectionMessage: '',
                error: '',

                async testConnection() {
                    this.testing = true;
                    this.connectionStatus = false;
                    
                    try {
                        const response = await fetch('/api/test');
                        const data = await response.json();
                        
                        this.connectionStatus = true;
                        this.connectionSuccess = data.success;
                        this.connectionMessage = data.success ? 
                            `‚úÖ ${data.message} (Found ${data.testResults} test candidates)` : 
                            `‚ùå ${data.error}`;
                    } catch (error) {
                        this.connectionStatus = true;
                        this.connectionSuccess = false;
                        this.connectionMessage = `‚ùå Connection failed: ${error.message}`;
                    }
                    
                    this.testing = false;
                },

                async searchCandidates(newSearch = true) {
                    this.searching = true;
                    this.error = '';
                    
                    if (newSearch) {
                        this.results = [];
                        this.currentPage = 1;
                        this.searchParams.page = 1;
                    }
                    
                    try {
                        const response = await fetch('/api/search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                ...this.searchParams,
                                page: this.currentPage
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Filter out candidates we've already seen
                            const newCandidates = data.candidates.filter(candidate => {
                                const key = candidate.linkedin_url;
                                if (this.seenCandidates.has(key)) {
                                    return false;
                                }
                                this.seenCandidates.add(key);
                                return true;
                            });
                            
                            if (newSearch) {
                                this.results = newCandidates;
                            } else {
                                this.results = [...this.results, ...newCandidates];
                            }
                        } else {
                            this.error = data.error || 'Search failed';
                        }
                    } catch (error) {
                        this.error = `Search failed: ${error.message}`;
                    }
                    
                    this.searching = false;
                },

                loadMoreCandidates() {
                    this.currentPage++;
                    this.searchCandidates(false);
                },

                tryDifferentSearch() {
                    const variations = ['visa_focus', 'new_grad', 'university', 'tech_specific', 'default'];
                    const currentIndex = variations.indexOf(this.searchParams.searchVariation);
                    const nextIndex = (currentIndex + 1) % variations.length;
                    this.searchParams.searchVariation = variations[nextIndex];
                    this.searchCandidates(true);
                }
            }
        }
    </script>
</body>
</html>
